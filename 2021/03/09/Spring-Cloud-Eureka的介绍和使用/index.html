<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Spring Cloud Eureka的介绍和使用 | 小曾博客</title><meta name="description" content="Spring Cloud Eureka 是一个基于REST的服务，并且提供了基于Java的客户端组件，能够非常方便地将服务注册到Spring Cloud Eureka中进行统一管理。 服务治理是微服务架构中必不可少的一部分，阿里开源的Dubbo框架就是针对服务治理的。服务治理必须要有一个注册中心，除了用Eureka作为注册中心外，我们还可以使用Consul、Zookeeper等来作为服务的注册中心"><meta name="keywords" content="SpringCloud"><meta name="author" content="小曾"><meta name="copyright" content="小曾"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Spring Cloud Eureka的介绍和使用"><meta name="twitter:description" content="Spring Cloud Eureka 是一个基于REST的服务，并且提供了基于Java的客户端组件，能够非常方便地将服务注册到Spring Cloud Eureka中进行统一管理。 服务治理是微服务架构中必不可少的一部分，阿里开源的Dubbo框架就是针对服务治理的。服务治理必须要有一个注册中心，除了用Eureka作为注册中心外，我们还可以使用Consul、Zookeeper等来作为服务的注册中心"><meta name="twitter:image" content="https://xiaozeng26.github.io/img/34567.jpg"><meta property="og:type" content="article"><meta property="og:title" content="Spring Cloud Eureka的介绍和使用"><meta property="og:url" content="https://xiaozeng26.github.io/2021/03/09/Spring-Cloud-Eureka%E7%9A%84%E4%BB%8B%E7%BB%8D%E5%92%8C%E4%BD%BF%E7%94%A8/"><meta property="og:site_name" content="小曾博客"><meta property="og:description" content="Spring Cloud Eureka 是一个基于REST的服务，并且提供了基于Java的客户端组件，能够非常方便地将服务注册到Spring Cloud Eureka中进行统一管理。 服务治理是微服务架构中必不可少的一部分，阿里开源的Dubbo框架就是针对服务治理的。服务治理必须要有一个注册中心，除了用Eureka作为注册中心外，我们还可以使用Consul、Zookeeper等来作为服务的注册中心"><meta property="og:image" content="https://xiaozeng26.github.io/img/34567.jpg"><meta property="article:published_time" content="2021-03-09T12:56:32.000Z"><meta property="article:modified_time" content="2021-03-13T06:53:01.244Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://xiaozeng26.github.io/2021/03/09/Spring-Cloud-Eureka%E7%9A%84%E4%BB%8B%E7%BB%8D%E5%92%8C%E4%BD%BF%E7%94%A8/"><link rel="prev" title="Ribbon的介绍及使用" href="https://xiaozeng26.github.io/2021/03/13/Ribbon%E7%9A%84%E4%BB%8B%E7%BB%8D%E5%8F%8A%E4%BD%BF%E7%94%A8/"><link rel="next" title="Spring Boot Starter的介绍和使用" href="https://xiaozeng26.github.io/2021/03/07/Spring-Boot-Starter%E7%9A%84%E4%BB%8B%E7%BB%8D%E5%92%8C%E4%BD%BF%E7%94%A8/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/disqusjs@1.2/dist/disqusjs.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xiaozeng26.github.io/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: true,
  islazyload: false,
  isanchor: true
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><link rel="stylesheet" href="/css/background.css"><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="小曾博客" type="application/atom+xml">
</head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.jfif" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">25</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">18</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">3</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-link"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 娱乐</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/photos/"><i class="fa-fw fa fa-picture-o"></i><span> Photos</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-使用-Eureka-编写注册中心服务"><span class="toc-number">1.</span> <span class="toc-text">1. 使用 Eureka 编写注册中心服务</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-使用Eureka编写服务提供者"><span class="toc-number">2.</span> <span class="toc-text">2. 使用Eureka编写服务提供者</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-创建项目注册到Eureka中"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 创建项目注册到Eureka中</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-提供消费者调用的接口"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 提供消费者调用的接口</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-使用Eureka编写服务消费者"><span class="toc-number">3.</span> <span class="toc-text">3. 使用Eureka编写服务消费者</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-直接调用服务提供者提供的接口"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 直接调用服务提供者提供的接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-通过Eureka来消费接口"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 通过Eureka来消费接口</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-Eureka注册中心开启密码认证"><span class="toc-number">4.</span> <span class="toc-text">4. Eureka注册中心开启密码认证</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-Eureka集群搭建"><span class="toc-number">5.</span> <span class="toc-text">5. Eureka集群搭建</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-Eureka的InstanceID配置。"><span class="toc-number">6.</span> <span class="toc-text">6. Eureka的InstanceID配置。</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-自定义Eureka的InstanceID"><span class="toc-number">6.1.</span> <span class="toc-text">1. 自定义Eureka的InstanceID</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-自定义实例跳转链接"><span class="toc-number">6.2.</span> <span class="toc-text">2. 自定义实例跳转链接</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-Eureka开发时快速移除失效服务"><span class="toc-number">7.</span> <span class="toc-text">7. Eureka开发时快速移除失效服务</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8-Eureka的REST-API及API扩展"><span class="toc-number">8.</span> <span class="toc-text">8. Eureka的REST API及API扩展</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1-Eureka-REST-API"><span class="toc-number">8.1.</span> <span class="toc-text">8.1 Eureka REST API</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-2-元数据的使用"><span class="toc-number">8.2.</span> <span class="toc-text">8.2 元数据的使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-3-EurekaClient的使用"><span class="toc-number">8.3.</span> <span class="toc-text">8.3 EurekaClient的使用</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(/img/34567.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">小曾博客</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-link"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于我</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 娱乐</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/photos/"><i class="fa-fw fa fa-picture-o"></i><span> Photos</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Spring Cloud Eureka的介绍和使用</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2021-03-09 20:56:32"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2021-03-09</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2021-03-13 14:53:01"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2021-03-13</span></time></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><p>Spring Cloud Eureka 是一个基于REST的服务，并且提供了基于Java的客户端组件，能够非常方便地将服务注册到Spring Cloud Eureka中进行统一管理。</p>
<p>服务治理是微服务架构中必不可少的一部分，阿里开源的Dubbo框架就是针对服务治理的。服务治理必须要有一个注册中心，除了用Eureka作为注册中心外，我们还可以使用Consul、Zookeeper等来作为服务的注册中心。</p>
<p>注册中心带来的好处就是，不需要知道有多少提供方，你只需要关注注册中心即可，就像顾客不必关心有多少火车在开，只需要去12306网站上看有没有票就可以了。</p>
<p>为什么Eureka比Zookeeper更合适作为注册中心呢？？主要是因为Eureka是基于AP原则构建的，而Zookeeper是基于CP原则构建的。</p>
<p>在分布式系统领域有个著名的CAP定理。即 C 为数据一致性；A 为服务可用性；P 为服务对网络分区故障的容错性。这三个特性在任何分布式系统中都不能同时满足，最多同时满足两个。</p>
<p>Zookeeper有一个Leader，而且在这个Leader无法使用的时候通过Paxos（ZAB）算法选举出一个新的Leader。这个Leader的任务就是保证写数据的时候只向这个Leader写入，Leader会同步信息到其他节点。通过这个操作就可以保证数据的一致性。</p>
<p>总而言之，想要保证AP就要用Eureka，想要保证CP就要用Zookeeper。</p>
<h1 id="1-使用-Eureka-编写注册中心服务"><a href="#1-使用-Eureka-编写注册中心服务" class="headerlink" title="1. 使用 Eureka 编写注册中心服务"></a>1. 使用 Eureka 编写注册中心服务</h1><p>首先使用Eureka搭建服务注册中心，创建一个Maven项目，取名为eureka-server，在pom.xml中配置Eureka的依赖信息，代码如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;parent&gt;</span><br><span class="line">       &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">       &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br><span class="line">       &lt;version&gt;2.0.6.RELEASE&lt;/version&gt;</span><br><span class="line">   &lt;/parent&gt;</span><br><span class="line"></span><br><span class="line">   &lt;dependencyManagement&gt;</span><br><span class="line">       &lt;dependencies&gt;</span><br><span class="line">           &lt;dependency&gt;</span><br><span class="line">               &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">               &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;</span><br><span class="line">               &lt;version&gt;Finchley.SR2&lt;/version&gt;</span><br><span class="line">               &lt;type&gt;pom&lt;/type&gt;</span><br><span class="line">               &lt;scope&gt;import&lt;/scope&gt;</span><br><span class="line">           &lt;/dependency&gt;</span><br><span class="line">       &lt;/dependencies&gt;</span><br><span class="line">   &lt;/dependencyManagement&gt;</span><br><span class="line"></span><br><span class="line">   &lt;dependencies&gt;</span><br><span class="line">       &lt;dependency&gt;</span><br><span class="line">           &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">           &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-server&lt;/artifactId&gt;</span><br><span class="line">           &lt;version&gt;2.1.3.RELEASE&lt;/version&gt;</span><br><span class="line">       &lt;/dependency&gt;</span><br><span class="line">   &lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>

<p>接下来在src/main/resources下面创建一个application.properties属性文件，增加下面的配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 服务器端口</span><br><span class="line">server.port=<span class="number">8010</span></span><br><span class="line"></span><br><span class="line"># 服务器名称</span><br><span class="line">spring.application.name=eureka-server</span><br><span class="line"></span><br><span class="line"># 是否将自己注册进注册中心</span><br><span class="line">eureka.client.register-with-eureka=<span class="keyword">false</span></span><br><span class="line"></span><br><span class="line"># 是否检索服务,注册中心的职责是维护服务实例，所以不检索服务</span><br><span class="line">eureka.client.fetch-registry=<span class="keyword">false</span></span><br></pre></td></tr></table></figure>

<p><strong>【注意：eureka.client.register-with-eureka一定要设置为false，因为自身本来就是server端，没办法将自己注册进去，所设置为true会报错】。</strong></p>
<p>创建一个启动类EurekaServerApplication，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.self.eurekaserver;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaServerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(EurekaServerApplication<span class="class">.<span class="keyword">class</span>,<span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里所说的启动类，跟一般的SpringBoot应用没什么区别，只是多了一个@EnableEurekaServer注解，表示开启Eureka Server。</p>
<p>最后，直接运行EurekaServerApplication就可以启动我们的注册中心服务了。可以直接通过<a href="http://localhost:8010访问，然后便会看到Eureka提供的Web控制台。">http://localhost:8010访问，然后便会看到Eureka提供的Web控制台。</a></p>
<h1 id="2-使用Eureka编写服务提供者"><a href="#2-使用Eureka编写服务提供者" class="headerlink" title="2. 使用Eureka编写服务提供者"></a>2. 使用Eureka编写服务提供者</h1><p>注册中心已经创建并且启动好了，接下来我们实现将一个服务提供者eureka-client-user-provider注册到Eureka中，并提供一个接口给其他服务调用。</p>
<h2 id="2-1-创建项目注册到Eureka中"><a href="#2-1-创建项目注册到Eureka中" class="headerlink" title="2.1 创建项目注册到Eureka中"></a>2.1 创建项目注册到Eureka中</h2><p>首先，创建一个Maven项目，然后在pom.xml中添加相关依赖，代码如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;parent&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.0.6.RELEASE&lt;/version&gt;</span><br><span class="line">&lt;/parent&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependencyManagement&gt;</span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;Finchley.SR2&lt;/version&gt;</span><br><span class="line">            &lt;type&gt;pom&lt;/type&gt;</span><br><span class="line">            &lt;scope&gt;import&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line">&lt;/dependencyManagement&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.3.0.RELEASE&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.1.0.RELEASE&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>

<p>接下来在src/main/resources下面创建一个application.properties属性文件，添加下面的配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 服务端口</span><br><span class="line">server.port=<span class="number">8011</span></span><br><span class="line"></span><br><span class="line"># 服务应用名称</span><br><span class="line">spring.application.name=eureka-client-user-provider</span><br><span class="line"></span><br><span class="line"># Eureka注册中心地址</span><br><span class="line">eureka.client.serviceUrl.defaultZone=http:<span class="comment">//localhost:8010/eureka/</span></span><br><span class="line"></span><br><span class="line"># 使用IP注册</span><br><span class="line">eureka.instance.prefer-ip-address=<span class="keyword">true</span></span><br><span class="line"></span><br><span class="line"># 定义实例ID格式</span><br><span class="line">eureka.instance.instance-id=$&#123;spring.application.name&#125;:$&#123;spring.cloud.client.ip-address&#125;:$&#123;server.port&#125;</span><br></pre></td></tr></table></figure>

<p>创建一个启动类UserProviderApplication，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.self.serverprovider;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserProviderApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(UserProviderApplication<span class="class">.<span class="keyword">class</span>,<span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以进一步检查服务是否注册成功。回到之前打开的Eureka的Web控制台，刷新页面，就可以看到新注册的服务信息了。结果如下：</p>
<p><img src="/img/springcloud/eureka/sucess.png" alt=""></p>
<p>不过需要注意的是，虽然是可以将服务提供者注册进注册中心，但是服务器控制台会一直报连接8761的错误，<strong>Eureka 注册中心一直报Connect to localhost:8761 time out 的问题</strong>，错误如图：</p>
<p><img src="/img/springcloud/eureka/bug.png" alt=""></p>
<p>解决这个问题很简单，只需要在注册中心的application.properties文件中加入defaultZone即可，因为默认是会连接8761端口，所以需要设置一个defaultZone进行覆盖默认的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eureka.client.service-url.defaultZone=http:<span class="comment">//localhost:8010/eureka/</span></span><br></pre></td></tr></table></figure>

<p>一般还会有一个警告，具体问题如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EMERGENCY! EUREKA MAY BE INCORRECTLY CLAIMING INSTANCES ARE UP WHEN THEY’RE NOT. RENEWALS ARE LESSER THAN THRESHOLD AND HENCE THE INSTANCES ARE NOT BEING EXPIRED JUST TO BE SAFE.</span><br></pre></td></tr></table></figure>

<p>这是Eureka的自我保护模式被启动了，当Eureka Server节点在短时间内丢失过多的实例的连接时，那么这个节点就会进入自我保护模式。一旦进入到该模式，Eureka Server就会保护服务注册表中的信息，不再删除服务注册表中的数据（即不会注销任何微服务）。</p>
<p>默认情况下，如果Eureka Server在一段时间内没有接受到某个微服务实例的心跳，便会注销该实例（默认是90秒），而一旦进入自我保护模式，那么即使关闭了指定实例，依然会发现该Eureka Server的注册实例中会存在被关闭的实例信息。</p>
<p>可以通过以下配置关闭Eureka的自我保护模式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> #关闭自我保护机制，保证不可用服务被及时剔除</span><br><span class="line">eureka.server.enable-self-preservation: <span class="keyword">false</span></span><br><span class="line"> #清理无效节点的时间间隔,默认60000毫秒,即60秒 (此处时间间隔设置为2s)</span><br><span class="line">eureka.server.eviction-interval-timer-in-ms: <span class="number">2000</span></span><br></pre></td></tr></table></figure>

<p><strong>建议：</strong></p>
<p>对于开发环境的Eureka Server，建议关闭它的自我保护模式，因为你可能需要不断的开启和关闭实例，如果并未关闭自我保护模式，那么很容易就会触发自我保护模式，此时调试会相当麻烦。</p>
<h2 id="2-2-提供消费者调用的接口"><a href="#2-2-提供消费者调用的接口" class="headerlink" title="2.2 提供消费者调用的接口"></a>2.2 提供消费者调用的接口</h2><p>创建一个Controller，这是给其他服务（消费者）调用的接口，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.self.serverprovider.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"hello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Hello world"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重启服务后，访问http:localhost:8011/user/hello,若能看到返回的Hello world 字符串，就证明接口提供成功。</p>
<h1 id="3-使用Eureka编写服务消费者"><a href="#3-使用Eureka编写服务消费者" class="headerlink" title="3. 使用Eureka编写服务消费者"></a>3. 使用Eureka编写服务消费者</h1><h2 id="3-1-直接调用服务提供者提供的接口"><a href="#3-1-直接调用服务提供者提供的接口" class="headerlink" title="3.1 直接调用服务提供者提供的接口"></a>3.1 直接调用服务提供者提供的接口</h2><p>创建服务消费者，消费上面岗编写的user/hello接口。首先同样需要先创建一个Maven项目eureka-client-article-consumer，然后添加依赖，依赖和服务提供者的一样，这里就不粘贴代码了。</p>
<p>application.properties代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 服务端口</span><br><span class="line">server.port=<span class="number">8012</span></span><br><span class="line"></span><br><span class="line"># 应用服务名称</span><br><span class="line">spring.application.name=eureka-client-article-consumer</span><br><span class="line"></span><br><span class="line"># Eureka注册中心地址</span><br><span class="line">eureka.client.service-url.defaultZone=http:<span class="comment">//localhost:8010/eureka/</span></span><br><span class="line"></span><br><span class="line"># 使用IP注册</span><br><span class="line">eureka.instance.prefer-ip-address=<span class="keyword">true</span></span><br><span class="line"></span><br><span class="line"># 定义实例ID格式</span><br><span class="line">eureka.instance.instance-id=$&#123;spring.application.name&#125;:$&#123;spring.cloud.client.ip-address&#125;:$&#123;server.port&#125;</span><br></pre></td></tr></table></figure>

<p><strong>【注意：服务消费者也需要加入注册中心，所以在application.properties中添加注册中心的地址】</strong></p>
<p>主启动类的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.self.articleconsumer;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line">        <span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line">        <span class="keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArticleConsumerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ArticleConsumerApplication<span class="class">.<span class="keyword">class</span>,<span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来就可以调用user/hello实现功能，但是如何才能调用到另一个模块中的接口呢？？</p>
<p>RestTemplate是Spring提供的用于访问Rest服务的客户端，RestTemplate提供了多种便捷访问远程Http服务的方法，能够大大提高客户端的编写效率。我们通过配置RestTemplate来调用接口，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.self.articleconsumer.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">getRestTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建接口，在接口中调用user/hello接口，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.self.articleconsumer.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArticleController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/article/callHello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">callHello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(<span class="string">"http://localhost:8011/user/hello"</span>,String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后，将注册中心，服务提供者以及服务消费者的模块分别启动之后，就可以通过访问/article/callHello接口来看看是否有结果返回，若返回了就证明调用成功。访问地址为：<a href="http://localhost:8012/article/callHello。" target="_blank" rel="noopener">http://localhost:8012/article/callHello。</a></p>
<p>结果如下截图：</p>
<p><img src="/img/springcloud/eureka/callHello.png" alt=""></p>
<h2 id="3-2-通过Eureka来消费接口"><a href="#3-2-通过Eureka来消费接口" class="headerlink" title="3.2 通过Eureka来消费接口"></a>3.2 通过Eureka来消费接口</h2><p>上面提到的方法是直接通过服务接口的地址来调用的，这样是可行，但是这样就完全没有用到Eureka带给我们的便利。既然用来注册中心，那么客户端调用的时候肯定是不需要关心有多少个服务提供接口，下面我们来改造一下之前的调用代码。</p>
<p>首先改造RestTemplate的配置，添加一个@LoadBalanced注解，这个注解会自动改造LoadBalancerClient接口的实现类并注册到Spring容器中，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.self.articleconsumer.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.loadbalancer.LoadBalanced;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">getRestTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>@LoadBalanced注解：</p>
<p><strong>作用：在使用RestTemplate的使用，如果RestTemplate上面有这个注解，那么这个RestTemplate调用的远程地址，会走负载均衡器。</strong></p>
<p><strong>原理：使用这个注解以后，会在restTemplate里面通过restTemplate.setInterceptors放入LoadBalancedInterceptor，这个拦截器会在请求远程接口的时候动态判断请求的域是不是负载均衡服务的地址，如果是，那么就会代理使用这个负载均衡器来调用。</strong></p>
<p>接下来就是写调用接口的代码，我们不再直接写固定地址，而是写成服务的名称，这个名称就是我们注册到Eureka中的名称，即application.properties中的spring.application.name,相关代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"article/callHello2"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">callHello2</span><span class="params">()</span></span>&#123;</span><br><span class="line">      <span class="keyword">return</span> restTemplate.getForObject(<span class="string">"http://eureka-client-user-provider/user/hello"</span>,String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>效果与之前的结果并没有什么区别。只是调用的接口不一样，如下：</p>
<p><img src="/img/springcloud/eureka/callHello2.png" alt=""></p>
<h1 id="4-Eureka注册中心开启密码认证"><a href="#4-Eureka注册中心开启密码认证" class="headerlink" title="4. Eureka注册中心开启密码认证"></a>4. Eureka注册中心开启密码认证</h1><p>因为Eureka自带了一个Web的管理界面，方便我们查询注册到上面的实例信息，但是也有一个问题：如果在实际使用中，注册中心地址有公网IP的话，必然能直接访问到，这样是不安全的。所以我们需要对Eureka进行改造，加上权限认证来保证安全性。</p>
<p>改造我们的eureka-server，通过Spring-Security来进行安全认证。</p>
<p>在pom.xml中添加Spring-Security的依赖包，代码如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">     &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">     &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;</span><br><span class="line">     &lt;version&gt;2.2.1.RELEASE&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>然后在application.properties中加入认证的配置信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># spring-security的配置信息：</span><br><span class="line">spring.security.user.name=xiaozeng</span><br><span class="line">spring.security.user.password=<span class="number">123456</span></span><br></pre></td></tr></table></figure>

<p>添加Security的配置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.self.eurekaserver.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//super.configure(http);</span></span><br><span class="line">        <span class="comment">//关闭csrf</span></span><br><span class="line">        http.csrf().disable();</span><br><span class="line">        <span class="comment">//支持httpBasic</span></span><br><span class="line">        http.authorizeRequests().anyRequest().authenticated().and().httpBasic();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此，重新启动注册中心，访问<a href="http://localhost:8010/此时浏览器会提示你输入用户名和密码，输入正确后才能继续访问Eureka提供的管理界面。然后将在application.properties中设置的用户名和密码填写就可以访问，效果截图如下：" target="_blank" rel="noopener">http://localhost:8010/此时浏览器会提示你输入用户名和密码，输入正确后才能继续访问Eureka提供的管理界面。然后将在application.properties中设置的用户名和密码填写就可以访问，效果截图如下：</a></p>
<p><img src="/img/springcloud/eureka/security.png" alt=""></p>
<p><strong>注意：在Eureka开启认证后，客户端注册的配置也要加上认证的用户名和密码信息，否则客户端是无法将服务注册进注册中心：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># Eureka注册中心地址</span><br><span class="line">eureka.client.service-url.defaultZone=http:<span class="comment">//xiaozeng:123456@localhost:8010/eureka/</span></span><br></pre></td></tr></table></figure>

<h1 id="5-Eureka集群搭建"><a href="#5-Eureka集群搭建" class="headerlink" title="5. Eureka集群搭建"></a>5. Eureka集群搭建</h1><p>前面我们搭建的注册中心只适合本地开发使用，在生产环境中必须搭建一个集群来保证高可用。Eureka的集群搭建方法很简单：每一台Eureka只需要在配置中指定另外多个Eureka的地址就可以实现一个集群的搭建了。</p>
<p>下面我们以2个节点为例来说明搭建方式。假设我们有master和slave1两台机器，需要做的就是：</p>
<ul>
<li>将master注册到slave1中。</li>
<li>将slave1注册到master中。</li>
</ul>
<p>如果是3台机器，以此类推：</p>
<ul>
<li>将master注册到slave1和slave2中。</li>
<li>将slave1注册到master和slave2中。</li>
<li>将slave2注册到master和slave1中。</li>
</ul>
<p><strong>搭建集群步骤：</strong></p>
<p>创建一个新的项目eureka-server-cluster,在该项目下分别创建eureka-server-master和eureka-server-slave1。代表的是master和slave1。</p>
<p>结构如下图：</p>
<p><img src="/img/springcloud/eureka/cluster.png" alt=""></p>
<p>在master和slave1项目的pom.xml中都导入下面的这些依赖：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.0.6.RELEASE&lt;/version&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencyManagement&gt;</span><br><span class="line">        &lt;dependencies&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;Finchley.SR2&lt;/version&gt;</span><br><span class="line">                &lt;type&gt;pom&lt;/type&gt;</span><br><span class="line">                &lt;scope&gt;import&lt;/scope&gt;</span><br><span class="line">            &lt;/dependency&gt;</span><br><span class="line">        &lt;/dependencies&gt;</span><br><span class="line">    &lt;/dependencyManagement&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-server&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.1.3.RELEASE&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.2.1.RELEASE&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>

<p>接下来写master的application.properties:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 服务器端口</span><br><span class="line">server.port=<span class="number">8100</span></span><br><span class="line"></span><br><span class="line"># 服务应用名称</span><br><span class="line">spring.application.name=eureka-server-master</span><br><span class="line"></span><br><span class="line">eureka.instance.hostname=eureka-server-master</span><br><span class="line"></span><br><span class="line"># 此应用为注册中心，false：不向注册中心注册自己。</span><br><span class="line">eureka.client.register-with-eureka = <span class="keyword">false</span></span><br><span class="line"></span><br><span class="line"># 注册中心职责是维护服务实例，false：不检索服务。</span><br><span class="line">eureka.client.fetch-registry=<span class="keyword">false</span></span><br><span class="line"></span><br><span class="line"># 指向从节点的地址</span><br><span class="line">eureka.client.service-url.defaultZone=http:<span class="comment">//xiaozeng:123456@eureka-server-slave1:8110/eureka/</span></span><br><span class="line"></span><br><span class="line"># spring-security的配置信息：</span><br><span class="line">spring.security.user.name=xiaozeng</span><br><span class="line">spring.security.user.password=<span class="number">123456</span></span><br></pre></td></tr></table></figure>

<p>slave的application.properties：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 服务器端口</span><br><span class="line">server.port=<span class="number">8110</span></span><br><span class="line"></span><br><span class="line"># 服务应用名称</span><br><span class="line">spring.application.name=eureka-server-slave1</span><br><span class="line"></span><br><span class="line">eureka.instance.hostname=eureka-server-slave1</span><br><span class="line"></span><br><span class="line"># 此应用为注册中心，false：不向注册中心注册自己。</span><br><span class="line">eureka.client.register-with-eureka = <span class="keyword">false</span></span><br><span class="line"></span><br><span class="line"># 注册中心职责是维护服务实例，false：不检索服务。</span><br><span class="line">eureka.client.fetch-registry=<span class="keyword">false</span></span><br><span class="line"></span><br><span class="line"># 指向主节点的地址</span><br><span class="line">eureka.client.service-url.defaultZone=http:<span class="comment">//xiaozeng:123456@eureka-server-master:8100/eureka/</span></span><br><span class="line"></span><br><span class="line"># spring-security的配置信息：</span><br><span class="line">spring.security.user.name=xiaozeng</span><br><span class="line">spring.security.user.password=<span class="number">123456</span></span><br></pre></td></tr></table></figure>

<p>然后就是master和slave的主启动类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.self.master;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MasterApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MasterApplication<span class="class">.<span class="keyword">class</span>,<span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.self.slave;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SlaveApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(SlaveApplication<span class="class">.<span class="keyword">class</span>,<span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后，可以在master和slave中都配置上spring-security的配置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.self.slave.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//super.configure(http);</span></span><br><span class="line">        <span class="comment">//关闭csrf</span></span><br><span class="line">        http.csrf().disable();</span><br><span class="line">        <span class="comment">//支持httpBasic</span></span><br><span class="line">        http.authorizeRequests().anyRequest().authenticated().and().httpBasic();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到这一步之后就可以启动master和slave模块，分别访问<a href="http://localhost:8100、http://localhost:8110可以出现以下结果代表配置集群搭建成功。结果如下图：">http://localhost:8100、http://localhost:8110可以出现以下结果代表配置集群搭建成功。结果如下图：</a></p>
<p><img src="/img/springcloud/eureka/master_slave1.png" alt=""></p>
<p>上图是主节点中注册了从节点，下图中是从节点中注册了主节点：</p>
<p><img src="/img/springcloud/eureka/slave1_master.png" alt=""></p>
<p>这样就将master注册到了slave1中，将slave1注册到master中，无论谁出现问题，应用都能继续使用存活的注册中心。</p>
<h1 id="6-Eureka的InstanceID配置。"><a href="#6-Eureka的InstanceID配置。" class="headerlink" title="6. Eureka的InstanceID配置。"></a>6. Eureka的InstanceID配置。</h1><h2 id="1-自定义Eureka的InstanceID"><a href="#1-自定义Eureka的InstanceID" class="headerlink" title="1. 自定义Eureka的InstanceID"></a>1. 自定义Eureka的InstanceID</h2><p>客户端在注册时，服务的Instance ID的默认值的格式如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;spring.cloud.client.hostname&#125;:$&#123;spring.application.name&#125;:$&#123;spring.application.instance_id:$&#123;server.port&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>翻译过来就是：”主机名：服务名称：服务端口”。当我们在Eureka的Web控制台查看服务注册信息的时候，就是这样的格式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UP (<span class="number">1</span>) - eureka-client-user-provider:<span class="number">8011</span></span><br></pre></td></tr></table></figure>

<p>很多时候，我们想把IP显示在上述的格式中，此时，只要把主机名替换成IP就可以了，或者调整顺序也可以。可以改成下面的样子，用 “服务名称：服务所在IP：服务端口”的格式来定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eureka.instance.instance-id=$&#123;spring.application.name&#125;:$&#123;spring.cloud.client.ip-address&#125;:$&#123;server.port&#125;</span><br></pre></td></tr></table></figure>

<p>定义之后我们看到的就是eureka-client-user-provider：192168.41.5:8011，这样做的话，一眼就能知道是哪个服务，在哪台机器上，端口是多少。</p>
<p>我们还可以点击服务的instance ID进行跳转，这时候显示的名称虽然变成了IP，但是跳转的链接却还是主机名。</p>
<p>所以还需要加一个配置才能让跳转的链接变成我们想要的样子，使用IP进行注册：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eureka.instance.prefer-ip-address=<span class="keyword">true</span></span><br></pre></td></tr></table></figure>

<h2 id="2-自定义实例跳转链接"><a href="#2-自定义实例跳转链接" class="headerlink" title="2. 自定义实例跳转链接"></a>2. 自定义实例跳转链接</h2><p>通过刚刚的配置实现了用IP进行注册，当点击InstanceID进行跳转的时候，就可以用IP跳转了，跳转的地址默认是IP + Port/info。我们可以自定义这个跳转的地址：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eureka.instance.status-page-url=http:<span class="comment">//www.baidu.com</span></span><br></pre></td></tr></table></figure>

<p>重启服务服务提供者后，当点击InstanceID的时候就可以跳往百度页面：</p>
<p><img src="/img/springcloud/eureka/pageUrl.png" alt=""></p>
<p><strong>【注意：需要理解的是，将IP注册的配置和实例跳转链接的配置是需要配置在服务提供者，而非配置在注册中心。需要理清楚哪些配置配置在哪很重要】</strong></p>
<h1 id="7-Eureka开发时快速移除失效服务"><a href="#7-Eureka开发时快速移除失效服务" class="headerlink" title="7. Eureka开发时快速移除失效服务"></a>7. Eureka开发时快速移除失效服务</h1><p>在实际开发过程中，我们可能会不停地重启服务，由于Eureka有自己的保护机制，故节点下线后，服务信息还会一直存在于Eureka中。我们可以通过增加一些配置让移除的速度更快一些，当然只在开发环境下使用，生产环境不推荐使用。</p>
<p>首先在我们的 eureka-server 中增加两个配置，分别是关闭自我保护和清理间隔：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">eureka.server.enable-self-preservation=<span class="keyword">false</span></span><br><span class="line"># 清理间隔，默认 60000 毫秒</span><br><span class="line">eureka.server.eviction-interval-timer-in-ms=<span class="number">5000</span></span><br></pre></td></tr></table></figure>

<p>然后在具体的客户端服务中配置下面的内容：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">eureka.client.healthcheck.enabled=<span class="keyword">true</span></span><br><span class="line"># 默认 30 秒</span><br><span class="line">eureka.instance.lease-renewal-interval-in-seconds=<span class="number">5</span></span><br><span class="line"># 默认 90 秒</span><br><span class="line">eureka.instance.lease-expiration-duration-in-seconds=<span class="number">5</span></span><br></pre></td></tr></table></figure>

<p>eureka.client.healthcheck.enabled用于开启健康检查，需要在pom.xml中引入actuator的依赖，代码如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>其中：</p>
<ul>
<li><p>eureka.instance.lease-renewal-interval-in-seconds 表示Eureka Client 发送心跳给server端的频率。</p>
</li>
<li><p>eureka.instance.lease-expiration-duration-in-seconds 表示Eureka Server 至上一次收到client的心跳之后，等待下一次心跳的超时时间，在这个时间内若没有收到下一次心跳，则移除该instance。</p>
</li>
</ul>
<p>更多的Instance配置信息可参考源码中的配置类：</p>
<p>org.springframework.cloud.netflix.eureka.EurekaInstanceConfigBean。</p>
<p>更多的Server配置信息可参考源码中的配置类：</p>
<p>org.springframework.cloud.netflix.server.EurekaServerConfigBean。</p>
<h1 id="8-Eureka的REST-API及API扩展"><a href="#8-Eureka的REST-API及API扩展" class="headerlink" title="8. Eureka的REST API及API扩展"></a>8. Eureka的REST API及API扩展</h1><p>这里讲解一些经常用到的配置信息以及Eureka的REST API，通过API 可以做一些扩展。</p>
<h2 id="8-1-Eureka-REST-API"><a href="#8-1-Eureka-REST-API" class="headerlink" title="8.1 Eureka REST API"></a>8.1 Eureka REST API</h2><p>Eureka作为注册中心，其本质是存储了每个客户端的注册信息，Ribbon在转发的时候会获取注册中心的服务列表，然后根据对应的路由规则来选择一个服务给Feign来进行调用。如果我们不是Spring Cloud技术选型，也想用Eureka，可以吗？？完全可以。</p>
<p>如果不是Spring Cloud技术栈，笔者推荐用Zookeeper，这样会方便些，当然用Eureka也是可以的，这样的话就会涉及如何注册信息、如何获取注册信息等操作，其实Eureka也考虑到了这点，提供了很多REST接口来给我们调用。</p>
<p>其实利用Eureka提供的API我们可以获取某个服务的实例信息，获取某个服务的注册信息，可以直接GET请求：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//localhost:8010/eureka/apps/eureka-client-article-consumer</span></span><br></pre></td></tr></table></figure>

<p>其中，localhost:8010是服务注册中心地址，eureka-client-article-consumer是应用名称（注册到注册中心的服务），即spring.application.name。</p>
<p>在浏览器中，数据的显示格式默认是XML格式的，如下图：</p>
<p><img src="/img/springcloud/eureka/registerInfo.png" alt=""></p>
<p>如果想反悔JSON数据的格式，可以用一些借口测试工具请求，比如Postman，在请求头添加下面两行代码即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Content-Type:application/json </span><br><span class="line">Accept: application/json</span><br></pre></td></tr></table></figure>

<p>如果Eureka开启了认证，记得添加认证信息，用户名和密码必须是Base64编码过的Authorization: Basic 用户名:密码。Postman直接支持Basic认证，将选项从Headers切换到Authorization,选择认证方式为Basic Auth 就可以填写用户信息。</p>
<p>填写完成后直接发起请求就可以获取JSON数据的服务注册信息:</p>
<p><img src="/img/springcloud/eureka/registerInfo_JSON.png" alt=""></p>
<h2 id="8-2-元数据的使用"><a href="#8-2-元数据的使用" class="headerlink" title="8.2 元数据的使用"></a>8.2 元数据的使用</h2><p>Eureka的元数据有两种类型，分别是框架定好了的标准元数据和用户自定义数据。标准元数据指的是主机名、IP地址、端口号、状态页和健康检查等信息，这些信息都会被发布在服务列表中，用于服务之间的调用。<strong>自定义元数据可以使用eureka.instance.metadataMap进行配置。</strong></p>
<p>自定义元数据说得通俗点就是自定义配置，我们可以为每个Eureka Client定义一些属于自己的配置，这个配置不会影响Eureka的功能。</p>
<p>自定义元数据可以用来做一些扩展信息，比如灰度发布之类的功能，可以用元数据来存储灰度发布的状态数据，Ribbon转发的时候就可以根据服务的元数据来做一些处理。当不需要灰度发布的时候可以调用Eureka提供的REST API将元数据清除掉。</p>
<p>下面我们可以自定义一个简单的元数据，在配置文件中配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eureka.instance.metadataMap.name=xiaozeng</span><br></pre></td></tr></table></figure>

<p>上述代码中定义了一个key为name的配置，value是xiaozeng。重启服务，然后通过Eureka提供的REST API 来查看刚刚配置的元数据是否已经存在于Eureka中。</p>
<p><img src="/img/springcloud/eureka/metadata.png" alt=""></p>
<p><strong>【注意: 元数据的配置是添加在客户端的配置文件中，而不是注册中心中】</strong></p>
<h2 id="8-3-EurekaClient的使用"><a href="#8-3-EurekaClient的使用" class="headerlink" title="8.3 EurekaClient的使用"></a>8.3 EurekaClient的使用</h2><p>当我们的项目集成了Eureka之后，可以通过EurekaClient来获取一些我们想要的数据，比如上面说的元数据，我们就可以通过EurekaClient来获取，不用再去调用Eureka提供的REST API。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.self.articleconsumer.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> com.netflix.discovery.EurekaClient eurekaClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/article/infos"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getMetaData</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> eurekaClient.getInstancesByVipAddress(<span class="string">"eureka-client-article-consumer"</span>,<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/source/img/springcloud/eureka/eurekaClient.png" alt=""></p>
<p>也可以用过Postman来调用接口查看返回的数据，这时我们会发现，通过EurekaClient 获取到的数据跟我们自己去调API获取的数据是一样的。从使用的角度来说，前者更方便。</p>
<p>除了使用EurekaClient，还可以使用DiscoveryClient，这个不是Feign自带的，是Spring Cloud重新封装的，类的路径为：org.springframework.cloud.client.discovery.DiscoveryClient。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/article/infos"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getMetaData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> discoveryClient.getInstances(<span class="string">"eureka-client-article-consumer"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">小曾</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://xiaozeng26.github.io/2021/03/09/Spring-Cloud-Eureka%E7%9A%84%E4%BB%8B%E7%BB%8D%E5%92%8C%E4%BD%BF%E7%94%A8/">https://xiaozeng26.github.io/2021/03/09/Spring-Cloud-Eureka%E7%9A%84%E4%BB%8B%E7%BB%8D%E5%92%8C%E4%BD%BF%E7%94%A8/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://xiaozeng26.github.io" target="_blank">小曾博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/SpringCloud/">SpringCloud</a></div><div class="post_share"><div class="social-share" data-image="/img/34567.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="/img/wechat.png" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="post-qr-code__img" src="/img/alipay.png" alt="支付宝"/><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2021/03/13/Ribbon%E7%9A%84%E4%BB%8B%E7%BB%8D%E5%8F%8A%E4%BD%BF%E7%94%A8/"><img class="prev_cover" src="/img/2759.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Ribbon的介绍及使用</div></div></a></div><div class="next-post pull_right"><a href="/2021/03/07/Spring-Boot-Starter%E7%9A%84%E4%BB%8B%E7%BB%8D%E5%92%8C%E4%BD%BF%E7%94%A8/"><img class="next_cover" src="/img/4272.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Spring Boot Starter的介绍和使用</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2021/03/20/Feign接口调用的介绍与实现/" title="Feign接口调用的介绍与实现"><img class="relatedPosts_cover" src="/img/1936.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2021-03-20</div><div class="relatedPosts_title">Feign接口调用的介绍与实现</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div id="disqus_thread"></div><script>var disqus_config = function () {
  this.page.url = 'https://xiaozeng26.github.io/2021/03/09/Spring-Cloud-Eureka%E7%9A%84%E4%BB%8B%E7%BB%8D%E5%92%8C%E4%BD%BF%E7%94%A8/';
  this.page.identifier = '2021/03/09/Spring-Cloud-Eureka的介绍和使用/';
  this.page.title = 'Spring Cloud Eureka的介绍和使用';
};
(function() { 
  var d = document, s = d.createElement('script');
  s.src = 'https://.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
})();
</script></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By 小曾</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div><div class="footer_custom_text">Hi, welcome to my <a href="http://xiaozeng26.github.io">blog</a>!</div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile@master/Hexo/js/hideMobileSidebar.js"></script></body></html>